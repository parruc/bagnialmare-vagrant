{% extends "base.html" %}

{% load l10n i18n query_string %}

{% block main_content %}
    {% comment %}
        TODO: Da rifattorizzare in un templatetag da usare sia qui che in hp?
    {% endcomment %}
    <div class="row">
        <form class="form-inline" action="{% url 'search' %}" method="get">
            <div class="col-lg-6">
                <input class="form-control" type="text" id="search_q"
                    name="q" value="{{ q }}" placeholder="{% trans 'What' %}" />
            </div>
            <div class="col-lg-6">
                <div class="input-group">
                    <input class="form-control" type="text" id="search_l"
                        name="l" value="{{ l }}" placeholder="{% trans 'Where' %}" />
                    <span class="input-group-btn">
                        <button type="submit" id="search_submit" class="btn btn-default" value="search">
                            {% trans "Search" %}
                        </button>
                    </span>
                </div>
            </div>
        </form>
    </div>
    {% if has_get %}
        <div class="row search">
            <div class="col-lg-3">
                {% for facet in active_facets %}
                    {% if forloop.first %}
                        <div class="panel">
                            <div class="panel-heading">
                                <h3>{% trans "Active filters" %}</h3>
                            </div>
                            <ul class="list-group">
                    {% endif %}
                        <li class="list-group-item">
                            <a href="?{{ facet.url }}">{% trans facet.group %}: {% trans facet.name %}</a>
                        </li>
                    {% if forloop.last %}
                        </ul>
                    </div>
                    {% endif %}
                {% endfor %}
                {% for facet_group, facet_values in facets.items %}
                    {% if facet_group %}
                        <div class="panel">
                            <div class="panel-heading">
                                <h3>{% trans facet_group %}</h3>
                            </div>
                            {% for facet in facet_values %}
                                {% if forloop.first %}
                                    <ul class="list-group">
                                {% endif %}
                                <li class="list-group-item">
                                    <span class="badge">{{ facet.count }}</span>
                                    <a href="?{{ facet.url }}">{{ facet.name }}</a>
                                </li>
                                {% if forloop.last %}
                                    </ul>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="col-lg-9">
                {% if hits %}
                    <p>
                        <span class="hits-count">{{ count }}</span>
                        {% if q %}
                            {% trans "results for" %} <span class="hits-query">{{ q }}</span>
                        {% else %}
                            {% trans "results" %}
                        {% endif %}
                        {% if place %}
                            {% trans "near" %} <span class="hits-query">{{ place }}</span>
                        {% endif %}

                        <span class="per-page">
                            {% trans ". Show" %}
                            <a href="{% query_string 'pp=10' 'pp' %}">10</a>
                            <a href="{% query_string 'pp=25' 'pp' %}">25</a>
                            <a href="{% query_string 'pp=50' 'pp' %}">50</a>
                            <a href="{% query_string 'pp=100' 'pp' %}">100</a>
                            {% trans "results per page" %}
                        </span>
                    </p>
                    <div id="bagno_map" style="width: 100%; height: 300px"></div>
                    {%  for hit in hits %}
                        <div class="panel">
                            <div class="panel-heading">
                                <h3>
                                    <a href="{{ hit.get_absolute_url }}">{{ hit.name }}</a>
                                    {% if hit.distance %}
                                        <span class="badge">{{hit.distance.km|floatformat:2 }}Km</span>
                                    {% endif %}
                                </h3>
                            </div>
                            {% if hit.services.all %}
                                {% with hit.services.all|dictsort:"category" as services %}
                                    {% regroup services by category as categorized_services %}
                                    <h2>{% trans "Services" %}</h2>
                                    <ul>
                                    {% for categorized_service in categorized_services %}
                                        <li>{% trans categorized_service.grouper.name %}
                                        <ul>
                                            {% for service in categorized_service.list %}
                                              <li>{% trans service.name %}</li>
                                            {% endfor %}
                                        </ul>
                                        </li>
                                    {% endfor %}
                                    </ul>
                                {% endwith %}
                            {% else %}
                                <div>{% trans "No service available" %}</div>
                            {% endif %}
                        </div>
                    {% endfor %}
                    <div class="pagination">
                        <span class="step-links">
                            {% if hits.has_previous %}
                                <a href="{% query_string 'p=hits.previous_page_number' 'p' %}">
                                    {% trans "previous" %}
                                </a>
                            {% endif %}

                            <span class="current">
                                {% blocktrans with num_pages=hits.paginator.num_pages page=hits.number %}Page {{ page }} of {{ num_pages }}.{% endblocktrans %}
                            </span>

                            {% if hits.has_next %}
                                <a href="{% query_string 'p=hits.next_page_number' 'p' %}">
                                    {% trans "next" %}
                                </a>
                            {% endif %}
                        </span>
                    </div>
                {% else %}
                    <div>{% trans "No results for the given search" %}</div>
                {% endif %}
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block specific_js %}
        <script type="text/javascript">
        var map
        $(function() {
            map = L.map('bagno_map');
            L.tileLayer('http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png', {
                attribution: 'Data, imagery and map information provided by <a href="http://open.mapquest.co.uk" target="_blank">MapQuest</a>, <a href="http://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> and contributors.',
                subdomains: ['otile1','otile2','otile3','otile4'],
                maxZoom: 18
            }).addTo(map);
            var markerBounds = new L.LatLngBounds();
            {% for bagno in hits %}
                {% if bagno.point.x and bagno.point.y %}
                    var p = new L.LatLng({{ bagno.point.y|unlocalize }}, {{ bagno.point.x|unlocalize }})
                    var marker = L.marker(p).addTo(map);
                    markerBounds.extend(p);
                    marker.bindPopup("<strong>{{ bagno.name }}</strong> <em>{{ bagno.address }}</em><br>").openPopup();
                {% endif %}
            {% endfor %}
            map.fitBounds(markerBounds);
        });
        </script>
{% endblock specific_js %}

{% block title %}{% trans "Search" %}{% endblock title %}

{% block pagetitle %}{% trans "Search" %}{% endblock pagetitle %}
